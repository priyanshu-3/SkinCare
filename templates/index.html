<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Skin Cancer Detection System</title>
    <!-- Version: 2.0 - Custom Error Modals -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .main-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
            margin: 20px;
            padding: 30px;
        }

        .upload-area {
            border: 3px dashed #007bff;
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            background: #f8f9fa;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .upload-area:hover, .upload-area.dragover {
            border-color: #0056b3;
            background: #e3f2fd;
            transform: scale(1.02);
        }

        .upload-area.dragover {
            background: #d1ecf1;
            border-color: #17a2b8;
        }

        .camera-container {
            position: relative;
            display: inline-block;
            margin: 20px 0;
        }

        .camera-preview {
            width: 100%;
            max-width: 400px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .result-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            border-left: 5px solid #007bff;
        }

        .severity-high { border-left-color: #dc3545; }
        .severity-medium { border-left-color: #ffc107; }
        .severity-low { border-left-color: #28a745; }

        .confidence-bar {
            height: 25px;
            border-radius: 12px;
            background: #e9ecef;
            overflow: hidden;
            margin: 10px 0;
        }

        .confidence-fill {
            height: 100%;
            background: linear-gradient(90deg, #007bff, #0056b3);
            transition: width 1s ease;
        }

        .prediction-item {
            padding: 10px;
            margin: 5px 0;
            border-radius: 8px;
            border-left: 4px solid #007bff;
        }

        .llm-advice {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            border-left: 5px solid #17a2b8;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
        }

        .llm-advice .alert {
            margin-bottom: 15px;
            border-radius: 8px;
        }

        .llm-advice .alert-info {
            background: linear-gradient(135deg, #d1ecf1, #bee5eb);
            border-color: #bee5eb;
        }

        .llm-advice .alert-warning {
            background: linear-gradient(135deg, #fff3cd, #ffeaa7);
            border-color: #ffeaa7;
        }

        .llm-advice .alert-success {
            background: linear-gradient(135deg, #d4edda, #c3e6cb);
            border-color: #c3e6cb;
        }

        .llm-advice .alert-danger {
            background: linear-gradient(135deg, #f8d7da, #f5c6cb);
            border-color: #f5c6cb;
        }

        .llm-advice .alert-primary {
            background: linear-gradient(135deg, #cce5ff, #b3d7ff);
            border-color: #b3d7ff;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #007bff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .btn-custom {
            background: linear-gradient(45deg, #007bff, #0056b3);
            border: none;
            border-radius: 25px;
            padding: 12px 30px;
            color: white;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .btn-custom:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,123,255,0.4);
        }

        .form-control:focus {
            border-color: #007bff;
            box-shadow: 0 0 0 0.2rem rgba(0,123,255,0.25);
        }

        .image-preview {
            max-width: 200px;
            max-height: 200px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            margin: 10px;
        }

        .tab-content {
            padding: 20px 0;
        }

        .nav-tabs .nav-link {
            border: none;
            border-radius: 10px 10px 0 0;
            color: #666;
            font-weight: bold;
        }

        .nav-tabs .nav-link.active {
            background: #007bff;
            color: white;
        }

        .disclaimer {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 10px;
            padding: 15px;
            margin: 20px 0;
        }

        /* Error Modal Styles */
        .error-modal {
            display: none;
            position: fixed;
            z-index: 9999;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            animation: fadeIn 0.3s ease;
        }

        .error-modal-content {
            background: white;
            margin: 10% auto;
            padding: 0;
            border-radius: 15px;
            max-width: 600px;
            box-shadow: 0 10px 50px rgba(0, 0, 0, 0.3);
            animation: slideDown 0.3s ease;
        }

        .error-modal-header {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
            padding: 25px 30px;
            border-radius: 15px 15px 0 0;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .error-modal-header i {
            font-size: 32px;
        }

        .error-modal-header h4 {
            margin: 0;
            flex-grow: 1;
            font-size: 24px;
            font-weight: 600;
        }

        .error-modal-close {
            background: none;
            border: none;
            color: white;
            font-size: 32px;
            cursor: pointer;
            opacity: 0.8;
            transition: opacity 0.3s;
            line-height: 1;
        }

        .error-modal-close:hover {
            opacity: 1;
        }

        .error-modal-body {
            padding: 30px;
        }

        .error-modal-body p {
            margin: 0;
            color: #374151;
            font-size: 16px;
            line-height: 1.8;
            white-space: pre-line;
        }

        .error-modal-footer {
            padding: 20px 30px;
            background: #f9fafb;
            border-radius: 0 0 15px 15px;
            text-align: right;
        }

        .error-modal-footer .btn {
            padding: 10px 30px;
            font-size: 16px;
            font-weight: 600;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row justify-content-center">
            <div class="col-lg-10">
                <div class="main-container">
                    <div class="text-center mb-4">
                        <h1 class="display-4 text-primary"><i class="fas fa-microscope"></i> Skin Cancer Detection System</h1>
                        <p class="lead text-muted">AI-powered skin lesion analysis with personalized medical insights</p>
                    </div>

                    <!-- Patient Information Form -->
                    <div class="card mb-4">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0"><i class="fas fa-user"></i> Patient Information</h5>
                        </div>
                        <div class="card-body">
                            <form id="patientForm">
                                <div class="row">
                                    <div class="col-md-4">
                                        <label for="name" class="form-label">Full Name *</label>
                                        <input type="text" class="form-control" id="name" required>
                                    </div>
                                    <div class="col-md-2">
                                        <label for="age" class="form-label">Age *</label>
                                        <input type="number" class="form-control" id="age" min="1" max="120" required>
                                    </div>
                                    <div class="col-md-3">
                                        <label for="gender" class="form-label">Gender *</label>
                                        <select class="form-select" id="gender" required>
                                            <option value="">Select Gender</option>
                                            <option value="Male">Male</option>
                                            <option value="Female">Female</option>
                                            <option value="Other">Other</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <label for="location" class="form-label">Location (City)</label>
                                        <input type="text" class="form-control" id="location" placeholder="Optional">
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>

                    <!-- Image Upload Section -->
                    <div class="card mb-4">
                        <div class="card-header bg-success text-white">
                            <h5 class="mb-0"><i class="fas fa-camera"></i> Image Capture & Upload</h5>
                        </div>
                        <div class="card-body">
                            <ul class="nav nav-tabs" id="uploadTabs" role="tablist">
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link active" id="upload-tab" data-bs-toggle="tab" data-bs-target="#upload" type="button" role="tab">File Upload</button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="camera-tab" data-bs-toggle="tab" data-bs-target="#camera" type="button" role="tab">Camera Capture</button>
                                </li>
                            </ul>

                            <div class="tab-content" id="uploadTabsContent">
                                <!-- File Upload Tab -->
                                <div class="tab-pane fade show active" id="upload" role="tabpanel">
                                    <div class="upload-area" id="uploadArea">
                                        <i class="fas fa-cloud-upload-alt fa-3x text-primary mb-3"></i>
                                        <h4>Drag & Drop Your Image Here</h4>
                                        <p class="text-muted">or <span class="text-primary" style="cursor: pointer;" onclick="document.getElementById('fileInput').click()">browse files</span></p>
                                        <input type="file" id="fileInput" accept="image/*" style="display: none;">
                                        <small class="text-muted">Supported formats: JPG, PNG, JPEG (Max: 16MB)</small>
                                    </div>
                                    <div id="imagePreview" class="text-center mt-3" style="display: none;">
                                        <img id="previewImg" class="image-preview" alt="Preview">
                                        <br>
                                        <button class="btn btn-success mt-2" onclick="analyzeImage()">Analyze Image</button>
                                    </div>
                                </div>

                                <!-- Camera Capture Tab -->
                                <div class="tab-pane fade" id="camera" role="tabpanel">
                                    <div class="text-center">
                                        <div class="camera-container">
                                            <video id="cameraVideo" class="camera-preview" autoplay playsinline style="display: none;"></video>
                                            <canvas id="canvas" style="display: none;"></canvas>
                                            <div id="cameraPlaceholder" class="upload-area" style="width: 400px; margin: 0 auto;">
                                                <i class="fas fa-camera fa-3x text-primary mb-3"></i>
                                                <h5>Camera Access Required</h5>
                                                <button class="btn btn-custom" onclick="startCamera()">Start Camera</button>
                                            </div>
                                        </div>
                                        <div class="mt-3">
                                            <button class="btn btn-success me-2" id="captureBtn" style="display: none;" onclick="captureImage()">
                                                <i class="fas fa-camera"></i> Capture
                                            </button>
                                            <button class="btn btn-danger" id="stopBtn" style="display: none;" onclick="stopCamera()">
                                                <i class="fas fa-stop"></i> Stop Camera
                                            </button>
                                        </div>
                                        <div id="capturedPreview" class="mt-3" style="display: none;">
                                            <img id="capturedImg" class="image-preview" alt="Captured">
                                            <br>
                                            <button class="btn btn-success mt-2" onclick="analyzeCapturedImage()">Analyze Captured Image</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Loading Indicator -->
                    <div class="loading" id="loading">
                        <div class="spinner"></div>
                        <h5>Analyzing your image...</h5>
                        <p class="text-muted">This may take a few moments</p>
                    </div>

                    <!-- Error Modal -->
                    <div class="error-modal" id="errorModal">
                        <div class="error-modal-content">
                            <div class="error-modal-header">
                                <i class="fas fa-exclamation-triangle"></i>
                                <h4 id="errorTitle">Error</h4>
                                <button class="error-modal-close" onclick="closeErrorModal()">&times;</button>
                            </div>
                            <div class="error-modal-body">
                                <p id="errorMessage"></p>
                            </div>
                            <div class="error-modal-footer">
                                <button class="btn btn-primary" onclick="closeErrorModal()">Try Again</button>
                            </div>
                        </div>
                    </div>

                    <!-- Results Section -->
                    <div id="results" style="display: none;">
                        <div class="result-card" id="resultCard">
                            <h3 class="text-center mb-4"><i class="fas fa-chart-bar"></i> Analysis Results</h3>

                            <div class="row">
                                <div class="col-md-6">
                                    <h5>Primary Diagnosis</h5>
                                    <div class="card border-primary">
                                        <div class="card-body">
                                            <h4 id="primaryDiagnosis" class="card-title text-primary"></h4>
                                            <div class="confidence-bar">
                                                <div class="confidence-fill" id="confidenceBar"></div>
                                            </div>
                                            <p class="mb-1"><strong>Confidence:</strong> <span id="confidenceText"></span></p>
                                            <p class="mb-1"><strong>Risk Level:</strong> <span id="riskLevel"></span></p>
                                            <p class="mb-0"><strong>Description:</strong> <span id="description"></span></p>
                                        </div>
                                    </div>
                                </div>

                                <div class="col-md-6">
                                    <h5>All Predictions</h5>
                                    <div id="allPredictions" class="list-group">
                                        <!-- Predictions will be populated here -->
                                    </div>
                                </div>
                            </div>

                            <div class="row mt-4">
                                <div class="col-12">
                                    <h5>Medical Insights & Recommendations</h5>
                                    <div class="llm-advice">
                                        <div id="llmAdvice">
                                            <div class="text-center">
                                                <div class="spinner"></div>
                                                <p>Generating personalized medical insights...</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="row mt-4">
                                <div class="col-md-6">
                                    <h5>Patient Information</h5>
                                    <div class="card mb-3">
                                        <div class="card-body">
                                            <p class="mb-1"><strong>Name:</strong> <span id="patientName"></span></p>
                                            <p class="mb-1"><strong>Age:</strong> <span id="patientAge"></span></p>
                                            <p class="mb-1"><strong>Gender:</strong> <span id="patientGender"></span></p>
                                            <p class="mb-0"><strong>Location:</strong> <span id="patientLocation"></span></p>
                                        </div>
                                    </div>
                                    <h5>Input Image</h5>
                                    <img id="resultImage" class="img-fluid rounded" alt="Input Image">
                                </div>
                                <div class="col-md-6">
                                    <h5>Analysis Visualization</h5>
                                    <img id="resultViz" class="img-fluid rounded" alt="Analysis Visualization">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Disclaimer -->
                    <div class="disclaimer">
                        <h6 class="text-warning"><i class="fas fa-exclamation-triangle"></i> Important Medical Disclaimer</h6>
                        <p class="mb-0">This AI-powered tool is for educational and informational purposes only. The results provided are not a substitute for professional medical advice, diagnosis, or treatment. Always consult with qualified healthcare professionals for proper medical evaluation and care.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentImageFile = null;
        let currentImageData = null;
        let stream = null;

        // Enhanced markdown to HTML converter for medical advice
        function formatMarkdown(text) {
            if (!text) return '';

            let html = text
                // Headers with icons and colored alerts
                .replace(/^## üìã Condition Overview$/gm, '<div class="alert alert-info border-0 shadow-sm mb-3"><h6 class="alert-heading mb-2 text-info"><i class="fas fa-info-circle me-2"></i>Condition Overview</h6><div class="ms-3">')
                .replace(/^## ‚ö†Ô∏è Important Precautions$/gm, '<div class="alert alert-warning border-0 shadow-sm mb-3"><h6 class="alert-heading mb-2 text-warning"><i class="fas fa-exclamation-triangle me-2"></i>Important Precautions</h6><div class="ms-3">')
                .replace(/^## üè• Recommended Medical Care$/gm, '<div class="alert alert-success border-0 shadow-sm mb-3"><h6 class="alert-heading mb-2 text-success"><i class="fas fa-hospital me-2"></i>Recommended Medical Care</h6><div class="ms-3">')
                .replace(/^## üö® When to Seek Immediate Attention$/gm, '<div class="alert alert-danger border-0 shadow-sm mb-3"><h6 class="alert-heading mb-2 text-danger"><i class="fas fa-ambulance me-2"></i>When to Seek Immediate Attention</h6><div class="ms-3">')
                .replace(/^## üíù Supportive Message$/gm, '<div class="alert alert-primary border-0 shadow-sm mb-3"><h6 class="alert-heading mb-2 text-primary"><i class="fas fa-heart me-2"></i>Supportive Message</h6><div class="ms-3">')
                .replace(/^## (.*)$/gm, '<h6 class="mt-3 mb-2 text-primary fw-bold">$1</h6>')

                // Bold text
                .replace(/\*\*(.*?)\*\*/g, '<strong class="text-dark">$1</strong>')

                // Bullet points with checkmarks
                .replace(/^\- (.*$)/gm, '<div class="d-flex align-items-start mb-2"><i class="fas fa-check-circle text-success me-2 mt-1 flex-shrink-0"></i><div>$1</div></div>')
                .replace(/^\‚Ä¢ (.*$)/gm, '<div class="d-flex align-items-start mb-2"><i class="fas fa-check-circle text-success me-2 mt-1 flex-shrink-0"></i><div>$1</div></div>')

                // Numbered lists with badges
                .replace(/^\d+\. (.*$)/gm, function(match, content) {
                    const num = match.match(/^\d+/)[0];
                    return '<div class="d-flex align-items-start mb-2"><span class="badge bg-primary me-2 mt-1 flex-shrink-0" style="min-width: 24px;">' + num + '</span><div>' + content + '</div></div>';
                })

                // Line breaks
                .replace(/\n\n+/g, '</div></div>')
                .replace(/\n/g, '<br>');

            // Clean up and ensure proper closing
            html = html.replace(/(<div class="alert[^>]*>)(?!<h6|<div)/g, '$1<div class="ms-3">');
            html = html.replace(/([^>])(<div class="alert)/g, '$1</div>$2');

            // Final cleanup
            html = html.replace(/<\/div><\/div>$/, '</div>');
            html = html.replace(/(<div class="alert[^>]*>)$/g, '$1</div>');

            return html;
        }

        // Drag and drop functionality
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const imagePreview = document.getElementById('imagePreview');
        const previewImg = document.getElementById('previewImg');

        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');

            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        });

        uploadArea.addEventListener('click', () => {
            fileInput.click();
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFile(e.target.files[0]);
            }
        });

        function handleFile(file) {
            if (!file.type.startsWith('image/')) {
                showErrorModal('Invalid File Type', 'Please select an image file (JPG, PNG, JPEG, etc.).');
                return;
            }

            currentImageFile = file;
            const reader = new FileReader();
            reader.onload = (e) => {
                previewImg.src = e.target.result;
                imagePreview.style.display = 'block';
            };
            reader.readAsDataURL(file);
        }

        // Camera functionality
        async function startCamera() {
            try {
                stream = await navigator.mediaDevices.getUserMedia({
                    video: { width: 640, height: 480 }
                });

                const camera = document.getElementById('cameraVideo');
                const placeholder = document.getElementById('cameraPlaceholder');

                camera.srcObject = stream;
                camera.style.display = 'block';
                placeholder.style.display = 'none';

                document.getElementById('captureBtn').style.display = 'inline-block';
                document.getElementById('stopBtn').style.display = 'inline-block';
            } catch (err) {
                showErrorModal('Camera Access Error', 'Unable to access camera: ' + err.message + '\n\nPlease check camera permissions in your browser settings.');
            }
        }

        function stopCamera() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }

            const camera = document.getElementById('cameraVideo');
            const placeholder = document.getElementById('cameraPlaceholder');

            camera.style.display = 'none';
            placeholder.style.display = 'block';
            document.getElementById('captureBtn').style.display = 'none';
            document.getElementById('stopBtn').style.display = 'none';
            document.getElementById('capturedPreview').style.display = 'none';
        }

        function captureImage() {
            const camera = document.getElementById('cameraVideo');
            const canvas = document.getElementById('canvas');
            const ctx = canvas.getContext('2d');

            canvas.width = camera.videoWidth;
            canvas.height = camera.videoHeight;
            ctx.drawImage(camera, 0, 0);

            const imageData = canvas.toDataURL('image/jpeg', 0.8);
            currentImageData = imageData;

            document.getElementById('capturedImg').src = imageData;
            document.getElementById('capturedPreview').style.display = 'block';
        }

        // Analysis functions
        async function analyzeImage() {
            if (!currentImageFile) {
                showErrorModal('No Image Selected', 'Please select or upload an image before analyzing.');
                return;
            }

            await performAnalysis(currentImageFile);
        }

        async function analyzeCapturedImage() {
            if (!currentImageData) {
                showErrorModal('No Image Captured', 'Please capture an image using the camera before analyzing.');
                return;
            }

            // Convert base64 to blob
            const response = await fetch(currentImageData);
            const blob = await response.blob();
            const file = new File([blob], 'captured.jpg', { type: 'image/jpeg' });

            await performAnalysis(file);
        }

        async function performAnalysis(imageFile) {
            // Validate form
            const name = document.getElementById('name').value.trim();
            const age = document.getElementById('age').value.trim();
            const gender = document.getElementById('gender').value;
            const location = document.getElementById('location').value.trim();

            if (!name || !age || !gender) {
                showErrorModal('Required Fields Missing', 'Please fill in all required fields:\n‚Ä¢ Name\n‚Ä¢ Age\n‚Ä¢ Gender');
                return;
            }

            // Show loading
            document.getElementById('loading').style.display = 'block';
            document.getElementById('results').style.display = 'none';

            try {
                const formData = new FormData();
                formData.append('image', imageFile);
                formData.append('name', name);
                formData.append('age', age);
                formData.append('gender', gender);
                formData.append('location', location);

                const response = await fetch('/analyze', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (!response.ok || result.error) {
                    // Display detailed error message in custom modal
                    const errorTitle = result.error || 'Analysis Failed';
                    const errorMessage = result.message || 'Unable to analyze the image. Please try again.';
                    
                    showErrorModal(errorTitle, errorMessage);
                    return;
                }

                displayResults(result);

            } catch (error) {
                showErrorModal('Analysis Failed', 'An unexpected error occurred:\n\n' + error.message + '\n\nPlease try again or contact support if the problem persists.');
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }

        function displayResults(result) {
            // Patient information
            if (result.patient_info) {
                document.getElementById('patientName').textContent = result.patient_info.name;
                document.getElementById('patientAge').textContent = result.patient_info.age;
                document.getElementById('patientGender').textContent = result.patient_info.gender;
                document.getElementById('patientLocation').textContent = result.patient_info.location || 'Not provided';
            }

            // Primary diagnosis
            document.getElementById('primaryDiagnosis').textContent = result.prediction;
            document.getElementById('confidenceText').textContent = result.confidence + '%';
            document.getElementById('confidenceBar').style.width = result.confidence + '%';

            const conditionInfo = result.condition_info;
            document.getElementById('riskLevel').textContent = conditionInfo.severity || 'Unknown';
            document.getElementById('description').textContent = conditionInfo.description || 'Consult a healthcare professional';

            // Update card color based on severity
            const resultCard = document.getElementById('resultCard');
            resultCard.className = 'result-card';
            if (conditionInfo.severity === 'VERY HIGH RISK') {
                resultCard.classList.add('severity-high');
            } else if (conditionInfo.severity === 'High Risk') {
                resultCard.classList.add('severity-high');
            } else if (conditionInfo.severity === 'Medium Risk') {
                resultCard.classList.add('severity-medium');
            } else {
                resultCard.classList.add('severity-low');
            }

            // All predictions
            const allPredictions = document.getElementById('allPredictions');
            allPredictions.innerHTML = '';

            const sortedPreds = Object.entries(result.all_predictions)
                .sort((a, b) => b[1].confidence - a[1].confidence);

            sortedPreds.forEach(([condition, data], index) => {
                const confidence = (data.confidence * 100).toFixed(2);
                const isTop = index === 0;

                const item = document.createElement('div');
                item.className = 'list-group-item prediction-item';
                item.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <strong>${condition}</strong>
                            ${isTop ? '<span class="badge bg-primary ms-2">Top Prediction</span>' : ''}
                        </div>
                        <span class="badge bg-secondary">${confidence}%</span>
                    </div>
                `;
                allPredictions.appendChild(item);
            });

            // LLM Advice
            document.getElementById('llmAdvice').innerHTML = formatMarkdown(result.llm_advice);

            // Images
            document.getElementById('resultImage').src = result.image_path;
            document.getElementById('resultViz').src = result.viz_path;

            // Show results
            document.getElementById('results').style.display = 'block';
            document.getElementById('results').scrollIntoView({ behavior: 'smooth' });
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            // Any initialization code here
        });

        // Error Modal Functions
        function showErrorModal(title, message) {
            document.getElementById('errorTitle').textContent = title;
            document.getElementById('errorMessage').textContent = message;
            document.getElementById('errorModal').style.display = 'block';
        }

        function closeErrorModal() {
            document.getElementById('errorModal').style.display = 'none';
        }

        // Close modal when clicking outside of it
        window.onclick = function(event) {
            const modal = document.getElementById('errorModal');
            if (event.target === modal) {
                closeErrorModal();
            }
        }
    </script>
</body>
</html>